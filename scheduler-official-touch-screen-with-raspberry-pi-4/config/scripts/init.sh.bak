#!/bin/bash
set -e

BASE_DIR="$HOME/Desktop/scheduler"
FONT_DIR="/usr/local/share/fonts/amiri"
AUTOSTART_DIR="$HOME/.config/autostart"
DONE_DIR="$BASE_DIR/var/.setup_done"
SERVICE_NAME="audio_event_scheduler.service"
SERVICE_PATH="/etc/systemd/system/$SERVICE_NAME"

mkdir -p "$DONE_DIR"

echo "==== Scheduler setup started ===="

#######################################
# Install required python packages
#######################################
if ! dpkg -s python3-pandas >/dev/null 2>&1; then
    echo "Installing python3-pandas..."
    sudo apt update
    sudo apt install -y python3-pandas
else
    echo "python3-pandas already installed"
fi

#######################################
# Install Amiri font
#######################################
if [[ ! -d "$FONT_DIR" ]]; then
    echo "Installing Amiri Arabic Font..."
    sudo mkdir -p "$FONT_DIR"
    sudo cp "$BASE_DIR/config/arabic-fonts/Amiri.zip" "$FONT_DIR/"
    sudo unzip -o "$FONT_DIR/Amiri.zip" -d "$FONT_DIR"
    sudo rm -f "$FONT_DIR/Amiri.zip" "$FONT_DIR/OFL.txt"
    sudo fc-cache -fv
else
    echo "Amiri font already installed"
fi

#######################################
# Replace hardcoded home directory (run once)
#######################################
if [[ ! -f "$DONE_DIR/home_replaced" ]]; then
    echo "Replacing hardcoded home directory paths..."

    cd "$BASE_DIR"
    grep -rl "/home/ihms" . || true

    find . -type f -exec sed -i "s|/home/ihms|$HOME|g" {} +
    find . -type f -exec sed -i "s|ihms|$USER|g" {} +

    touch "$DONE_DIR/home_replaced"
    cd -
else
    echo "Home directory replacement already done"
fi

#######################################
# Apply settings script (run once)
#######################################
if [[ ! -f "$DONE_DIR/settings_applied" ]]; then
    echo "Applying settings..."
    bash "$BASE_DIR/config/scripts/apply_settings.sh"
    touch "$DONE_DIR/settings_applied"
else
    echo "Settings already applied"
fi

#######################################
# Desktop shortcuts
#######################################
cd "$HOME/Desktop"

for desktop_file in \
    "$BASE_DIR/config/prayer_times_gui.desktop" \
    "$BASE_DIR/config/scheduler_settings_gui.desktop"
do
    link_name="$(basename "$desktop_file")"
    if [[ ! -L "$link_name" ]]; then
        ln -s "$desktop_file"
        echo "Created shortcut: $link_name"
    else
        echo "Shortcut already exists: $link_name"
    fi
done

cd -

#######################################
# Copy icons
#######################################
if [[ ! -f "$DONE_DIR/icons_installed" ]]; then
    echo "Installing icons..."
    sudo cp "$BASE_DIR/config/icons/athan-"*.png /usr/share/icons/hicolor/48x48/apps/
    sudo gtk-update-icon-cache /usr/share/icons/hicolor
    touch "$DONE_DIR/icons_installed"
else
    echo "Icons already installed"
fi

#######################################
# Systemd service
#######################################
if [[ ! -f "$SERVICE_PATH" ]]; then
    echo "Installing systemd service..."
    sudo cp "$BASE_DIR/config/systemd/$SERVICE_NAME" "$SERVICE_PATH"
    sudo systemctl daemon-reload
fi

if ! systemctl is-enabled --quiet "$SERVICE_NAME"; then
    sudo systemctl enable "$SERVICE_NAME"
fi

if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    sudo systemctl start "$SERVICE_NAME"
fi

#######################################
# Autostart entry
#######################################
mkdir -p "$AUTOSTART_DIR"

AUTOSTART_LINK="$AUTOSTART_DIR/prayer_times_gui.desktop"
TARGET="$BASE_DIR/config/prayer_times_gui.desktop"

if [[ ! -L "$AUTOSTART_LINK" ]]; then
    ln -s "$TARGET" "$AUTOSTART_LINK"
    echo "Autostart entry created"
else
    echo "Autostart entry already exists"
fi

echo "==== Scheduler setup completed successfully ===="

